<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>掌上庫存 (通用版)</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <!-- Scanner & Barcode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .ios-input { -webkit-appearance: none; }
        @keyframes fade-in-up { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .toast-enter { animation: fade-in-up 0.3s ease-out forwards; }
        @keyframes shine { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        .ai-gradient { background: linear-gradient(to right, #4f46e5, #9333ea, #4f46e5); background-size: 200% auto; animation: shine 3s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 設定與初始化邏輯 ---
        
        // 1. 嘗試獲取 Firebase 設定 (相容 Canvas 環境與本地環境)
        let firebaseConfig = null;
        let isCloudMode = false;
        
        try {
            // 如果是在 Canvas 環境，這個變數會存在
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                isCloudMode = true;
            }
        } catch (e) {
            console.log("Running in local/demo mode");
        }

        // 初始化 Firebase (如果有設定的話)
        let auth, db;
        if (isCloudMode && firebaseConfig) {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        }

        // --- 本地儲存模擬器 (LocalStorage Adapter) ---
        const LocalDB = {
            getKey: (collection) => `local_db_${collection}`,
            getAll: (collection) => {
                const data = localStorage.getItem(LocalDB.getKey(collection));
                return data ? JSON.parse(data) : [];
            },
            add: (collection, item) => {
                const items = LocalDB.getAll(collection);
                const newItem = { ...item, id: 'local_' + Date.now(), timestamp: { seconds: Date.now() / 1000 } };
                items.unshift(newItem);
                localStorage.setItem(LocalDB.getKey(collection), JSON.stringify(items));
                return newItem;
            },
            update: (collection, id, updates) => {
                const items = LocalDB.getAll(collection);
                const index = items.findIndex(i => i.id === id);
                if (index !== -1) {
                    items[index] = { ...items[index], ...updates };
                    localStorage.setItem(LocalDB.getKey(collection), JSON.stringify(items));
                }
            },
            delete: (collection, id) => {
                const items = LocalDB.getAll(collection);
                const newItems = items.filter(i => i.id !== id);
                localStorage.setItem(LocalDB.getKey(collection), JSON.stringify(newItems));
            }
        };

        // --- Icons ---
        const Icons = {
            Camera: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>),
            Barcode: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></svg>),
            Plus: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>),
            Search: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>),
            ArrowLeft: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>),
            ImageIcon: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>),
            X: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>),
            RefreshCw: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>),
            AlertCircle: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>),
            Sparkles: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>),
            Wand: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>),
            Download: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>),
            LogOut: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>),
            User: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>),
            Settings: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>),
            Users: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>),
            CloudOff: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="1" y1="1" x2="23" y2="23"/><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 7h1.8"/><path d="M5 15a5 5 0 0 0 7 7h1a5 5 0 0 0 2.6-.73"/></svg>),
            Key: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>)
        };
        const { Camera, Barcode, Plus, Search, ArrowLeft, ImageIcon, X, RefreshCw, AlertCircle, Sparkles, Wand, Download, LogOut, User, Settings, Users, CloudOff, Key } = Icons;

        // --- Utils & AI ---
        const callGemini = async (prompt, imageBase64 = null, apiKey = null) => {
            if(!apiKey) return "請先在設定中填入 Gemini API Key 才能使用 AI 功能。";
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const parts = [{ text: prompt }];
            if (imageBase64) {
                const base64Data = imageBase64.replace(/^data:image\/(png|jpeg|jpg);base64,/, '');
                parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Data } });
            }
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts }] }) });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI 無法產生回應";
            } catch (error) { throw error; }
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
                reader.onerror = reject;
            });
        };

        const generateRandomBarcode = () => Math.floor(100000000000 + Math.random() * 900000000000).toString();

        // --- Components ---
        const Toast = ({ message, type = 'info', onClose }) => {
            React.useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            const bgClass = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-gray-800';
            return (
                <div className={`fixed bottom-20 left-1/2 transform -translate-x-1/2 ${bgClass} text-white px-6 py-3 rounded-full shadow-xl z-50 toast-enter flex items-center gap-2 whitespace-nowrap`}>
                    {type === 'error' && <AlertCircle size={18} />} {type === 'magic' && <Sparkles size={18} className="text-yellow-300" />} <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const BarcodeDisplay = ({ value }) => {
            const svgRef = React.useRef(null);
            React.useEffect(() => {
                if (svgRef.current && value) try { JsBarcode(svgRef.current, value, { format: "CODE128", lineColor: "#000", width: 2, height: 60, displayValue: true }); } catch (e) {}
            }, [value]);
            return <svg ref={svgRef} className="w-full h-auto max-w-[200px]"></svg>;
        };

        const Scanner = ({ onScan, onClose, onError }) => {
            React.useEffect(() => {
                const html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
                    (decodedText) => { html5QrCode.stop().then(() => onScan(decodedText)); }, () => {}
                ).catch(err => { if (onError) onError("無法啟動相機 (請確保在 HTTPS 網址或 Localhost 下執行)"); });
                return () => { if(html5QrCode.isScanning) html5QrCode.stop().catch(e=>{}); };
            }, []);
            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col justify-center items-center">
                    <div className="text-white mb-4 text-lg font-bold">掃描商品條碼</div>
                    <div id="reader" className="w-full max-w-sm bg-black"></div>
                    <button onClick={onClose} className="mt-8 px-6 py-3 bg-red-600 text-white rounded-full font-bold shadow-lg">關閉相機</button>
                </div>
            );
        };

        const ProductCard = ({ product, onClick }) => (
            <div onClick={onClick} className="bg-white rounded-xl shadow-sm p-4 flex items-center gap-4 active:bg-gray-50 transition-colors cursor-pointer border border-gray-100 relative overflow-hidden">
                {product.description && <div className="absolute top-0 right-0 w-3 h-3 bg-purple-400 rounded-bl-lg"></div>}
                <div className="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 overflow-hidden relative">
                    {product.image ? <img src={product.image} className="w-full h-full object-cover" /> : <ImageIcon className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-400" size={24} />}
                </div>
                <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-gray-800 text-lg truncate">{product.name}</h3>
                    <p className="text-gray-500 text-sm flex items-center gap-1"><Barcode size={14} /> {product.barcode}</p>
                    <div className="mt-2 flex flex-col gap-1">
                        <div className="flex gap-2 overflow-x-auto pb-1">
                            {product.platforms && product.platforms.length > 0 ? product.platforms.map((p, idx) => (<span key={idx} className="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-md whitespace-nowrap">{p.name}: ${p.price}</span>)) : <span className="text-gray-400 text-xs">無價格設定</span>}
                        </div>
                        {product.lastEditor && <div className="text-[10px] text-gray-400 flex items-center gap-1"><User size={10} /> {product.lastEditor.split('@')[0]}</div>}
                    </div>
                </div>
            </div>
        );

        const LoginScreen = ({ onLogin, onRegister, isLocal }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [mode, setMode] = React.useState('login');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                if (isLocal) {
                    setTimeout(() => onLogin(email || "local@user.com", "password"), 500);
                } else {
                    try {
                        if (mode === 'login') await onLogin(email, password);
                        else await onRegister(email, password);
                    } catch (e) { console.error(e); }
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-700 flex flex-col justify-center items-center p-6 text-white">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 text-gray-800">
                        <div className="text-center mb-8">
                            <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${isLocal ? 'bg-orange-100' : 'bg-blue-100'}`}>
                                {isLocal ? <CloudOff size={32} className="text-orange-600" /> : <User size={32} className="text-blue-600" />}
                            </div>
                            <h2 className="text-2xl font-bold">{isLocal ? '單機試用模式' : (mode === 'login' ? '登入雲端帳號' : '註冊新帳號')}</h2>
                            <p className="text-gray-500 text-sm mt-2">{isLocal ? '目前為離線模式，資料僅存在此裝置' : (mode === 'login' ? '登入後即可在多裝置同步資料' : '建立帳號以保存您的庫存資料')}</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Email / 使用者名稱</label>
                                <input type="text" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg outline-none" placeholder={isLocal ? "設定一個名稱 (如: 店長)" : "name@example.com"} />
                            </div>
                            {!isLocal && <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                                <input type="password" required minLength="6" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg outline-none" placeholder="至少 6 位數" />
                            </div>}
                            <button type="submit" disabled={loading} className={`w-full py-3 text-white rounded-lg font-bold shadow-lg transition-all active:scale-95 disabled:opacity-50 ${isLocal ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                {loading ? '處理中...' : (isLocal ? '開始使用' : (mode === 'login' ? '登入' : '註冊'))}
                            </button>
                        </form>
                        {!isLocal && <div className="mt-6 text-center text-sm">{mode === 'login' ? <p>還沒有帳號？ <button onClick={() => setMode('register')} className="text-blue-600 font-bold hover:underline">免費註冊</button></p> : <p>已有帳號？ <button onClick={() => setMode('login')} className="text-blue-600 font-bold hover:underline">直接登入</button></p>}</div>}
                    </div>
                </div>
            );
        };

        const SettingsView = ({ companyId, setCompanyId, onClose, userEmail, isLocal, apiKey, setApiKey }) => {
            const [tempId, setTempId] = React.useState(companyId || '');
            const [tempKey, setTempKey] = React.useState(apiKey || '');

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col">
                    <div className="bg-white p-4 shadow-sm flex items-center gap-3">
                        <button onClick={onClose}><ArrowLeft className="text-gray-600" /></button>
                        <h1 className="text-lg font-bold text-gray-800">系統設定</h1>
                    </div>
                    <div className="p-4 space-y-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm">
                            <h2 className="text-sm font-bold text-gray-500 uppercase mb-4 flex items-center gap-2"><User size={16} /> 帳號資訊</h2>
                            <div className="text-lg font-medium text-gray-800">{userEmail}</div>
                            {isLocal && <div className="text-xs text-orange-500 mt-1">單機模式：資料僅儲存於瀏覽器</div>}
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow-sm">
                            <h2 className="text-sm font-bold text-blue-600 uppercase mb-4 flex items-center gap-2"><Users size={16} /> 公司/團隊共用設定</h2>
                            <p className="text-sm text-gray-500 mb-3">{isLocal ? "單機模式下，此設定僅用於分類，無法跨裝置同步。" : "輸入相同的「公司代碼」，不同帳號即可存取同一份庫存資料。"}</p>
                            <label className="block text-sm font-medium text-gray-700 mb-1">公司代碼</label>
                            <input value={tempId} onChange={(e) => setTempId(e.target.value)} placeholder="例如: my_shop_888" className="w-full p-3 bg-gray-50 rounded-lg border outline-none" />
                            <div className="mt-2 text-xs text-gray-400">{tempId ? `目前代碼: ${tempId}` : "目前模式：個人私有"}</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow-sm">
                            <h2 className="text-sm font-bold text-purple-600 uppercase mb-4 flex items-center gap-2"><Key size={16} /> Gemini API 設定 (AI 功能)</h2>
                            <p className="text-sm text-gray-500 mb-3">若要使用圖片辨識與文案生成，請填入您的 API Key。</p>
                            <label className="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                            <input type="password" value={tempKey} onChange={(e) => setTempKey(e.target.value)} placeholder="AIzaSy..." className="w-full p-3 bg-gray-50 rounded-lg border outline-none" />
                        </div>
                        <button onClick={() => { setCompanyId(tempId.trim()); setApiKey(tempKey.trim()); onClose(); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg mt-4">儲存設定</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('list'); 
            const [products, setProducts] = React.useState([]);
            const [currentProduct, setCurrentProduct] = React.useState(null);
            const [scanCallback, setScanCallback] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [aiLoading, setAiLoading] = React.useState(false); 
            const [searchTerm, setSearchTerm] = React.useState('');
            const [toast, setToast] = React.useState(null);
            const [companyId, setCompanyIdState] = React.useState(() => localStorage.getItem('inventory_company_id') || '');
            const [apiKey, setApiKeyState] = React.useState(() => localStorage.getItem('inventory_api_key') || '');

            const setCompanyId = (id) => {
                setCompanyIdState(id);
                localStorage.setItem('inventory_company_id', id);
                showToast(id ? `已切換至: ${id}` : "已切換回個人模式", "success");
            };

            const setApiKey = (key) => {
                setApiKeyState(key);
                localStorage.setItem('inventory_api_key', key);
            };

            const showToast = (message, type = 'info') => setToast({ message, type });

            // Auth Initialization
            React.useEffect(() => {
                if (isCloudMode) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        auth.signInWithCustomToken(__initial_auth_token).catch(e => console.error(e));
                    }
                    auth.onAuthStateChanged((u) => setUser(u));
                }
            }, []);

            // Data Fetching
            React.useEffect(() => {
                if (!user) { setProducts([]); return; }

                if (isCloudMode) {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app';
                    let q;
                    if (companyId) {
                        q = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory').where('companyId', '==', companyId);
                    } else {
                        q = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('products').orderBy('timestamp', 'desc');
                    }
                    const unsubscribe = q.onSnapshot((snapshot) => {
                        let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (companyId) items.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                        setProducts(items);
                    }, (error) => showToast("讀取失敗 (請檢查權限)", "error"));
                    return () => unsubscribe();
                } else {
                    // LocalStorage Mode
                    const collectionKey = companyId ? `shared_${companyId}` : `user_${user.uid}`;
                    const items = LocalDB.getAll(collectionKey);
                    setProducts(items);
                }
            }, [user, companyId, view]); 

            // Handlers
            const handleLogin = async (email, password) => {
                if (isCloudMode) {
                    try { await auth.signInWithEmailAndPassword(email, password); showToast("登入成功！"); }
                    catch (e) { showToast("登入失敗: " + e.message, "error"); }
                } else {
                    const fakeUser = { uid: "local_user", email: email };
                    setUser(fakeUser);
                    showToast("單機模式登入成功", "success");
                }
            };

            const handleRegister = async (email, password) => {
                try { await auth.createUserWithEmailAndPassword(email, password); showToast("註冊成功！"); }
                catch (e) { showToast("註冊失敗: " + e.message, "error"); }
            };

            const handleLogout = async () => {
                if(confirm("確定要登出嗎？")) {
                    if (isCloudMode) await auth.signOut();
                    setUser(null);
                    showToast("已登出");
                }
            };

            const handleExportCSV = () => {
                if (products.length === 0) return showToast("無資料可匯出", "error");
                const headers = ["商品名稱", "條碼", "上次售出價格", "上次售出備註", "平台價格", "文案", "自訂", "修改人"];
                const rows = products.map(p => {
                    const escape = (t) => t ? `"${t.toString().replace(/"/g, '""')}"` : "";
                    return [
                        escape(p.name), escape(p.barcode), escape(p.lastSoldPrice), escape(p.lastSoldNote),
                        escape((p.platforms || []).map(x => `${x.name}:$${x.price}`).join("|")),
                        escape(p.description), escape((p.customFields || []).map(x => `${x.label}:${x.value}`).join("|")),
                        escape(p.lastEditor)
                    ].join(",");
                });
                const blob = new Blob(["\uFEFF" + [headers.join(","), ...rows].join("\n")], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `庫存_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            const handleAIIdentify = async () => {
                if (!currentProduct.image) return showToast("請先上傳照片", "error");
                setAiLoading(true);
                try {
                    const res = await callGemini("請辨識此商品名稱，只回傳名稱", currentProduct.image, apiKey);
                    setCurrentProduct(prev => ({ ...prev, name: res.trim() }));
                    showToast("辨識成功！", "magic");
                } catch (e) { showToast("請確認 API Key 是否正確", "error"); }
                setAiLoading(false);
            };

            const handleAIGenerateDesc = async () => {
                if (!currentProduct.name) return showToast("請先輸入名稱", "error");
                setAiLoading(true);
                try {
                    const res = await callGemini(`為 ${currentProduct.name} 寫一段 100 字內的 FB 銷售貼文，活潑帶 emoji。`, currentProduct.image, apiKey);
                    setCurrentProduct(prev => ({ ...prev, description: res }));
                    showToast("生成成功！", "magic");
                } catch (e) { showToast("請確認 API Key 是否正確", "error"); }
                setAiLoading(false);
            };

            const handleSave = async () => {
                if (!currentProduct.name) return showToast("請輸入名稱", "error");
                setLoading(true);
                try {
                    const data = { ...currentProduct, lastEditor: user.email };
                    if (isCloudMode) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app';
                        let ref = companyId 
                            ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory')
                            : db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('products');
                        if (data.companyId === undefined && companyId) data.companyId = companyId;
                        data.timestamp = firebase.firestore.FieldValue.serverTimestamp();
                        if (currentProduct.id) await ref.doc(currentProduct.id).update(data);
                        else await ref.add(data);
                    } else {
                        const collection = companyId ? `shared_${companyId}` : `user_${user.uid}`;
                        if (currentProduct.id) LocalDB.update(collection, currentProduct.id, data);
                        else LocalDB.add(collection, data);
                        setProducts(LocalDB.getAll(collection));
                    }
                    showToast("儲存成功");
                    setView('list');
                    setCurrentProduct(null);
                } catch (e) { console.error(e); showToast("儲存失敗", "error"); }
                setLoading(false);
            };

            const handleDelete = async (id) => {
                if (!confirm("確定刪除？")) return;
                if (isCloudMode) {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app';
                    let ref = companyId 
                            ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory')
                            : db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('products');
                    await ref.doc(id).delete();
                } else {
                    const collection = companyId ? `shared_${companyId}` : `user_${user.uid}`;
                    LocalDB.delete(collection, id);
                    setProducts(LocalDB.getAll(collection));
                }
                setView('list');
                showToast("已刪除");
            };

            // Helpers for Edit View
            const handleImg = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    setLoading(true);
                    try { 
                        const base64 = await compressImage(file);
                        setCurrentProduct(prev => ({ ...prev, image: base64 }));
                    } catch (e) {
                        console.error("Image upload error", e);
                    }
                    setLoading(false);
                }
            };
            
            // --- UI Rendering ---
            if (!user) return <><LoginScreen onLogin={handleLogin} onRegister={handleRegister} isLocal={!isCloudMode} />{toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}</>;
            if (view === 'settings') return <SettingsView companyId={companyId} setCompanyId={setCompanyId} apiKey={apiKey} setApiKey={setApiKey} onClose={() => setView('list')} userEmail={user.email} isLocal={!isCloudMode} />;
            if (view === 'scan') return <><Scanner onScan={(code)=>{ setView('list'); if (scanCallback==='edit') { setCurrentProduct(p=>({...p, barcode:code})); setView('edit'); } else { const found = products.find(p=>p.barcode===code); if(found){ setCurrentProduct(found); setView('detail'); } else if(confirm('查無此商品，新增嗎？')) { setCurrentProduct({name:'', barcode:code, platforms:[{name:'蝦皮',price:''},{name:'FB',price:''},{name:'現場',price:''}], customFields:[]}); setView('edit'); } } setScanCallback(null); }} onClose={() => setView(scanCallback === 'edit' ? 'edit' : 'list')} />{toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}</>;

            return (
                <div className="min-h-screen pb-24">
                    <div className="bg-blue-600 text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-20">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-2xl font-bold">我的庫存 {companyId && <span className="text-xs bg-blue-800 px-2 py-1 rounded ml-2">{companyId}</span>}</h1>
                            <div className="flex gap-2">
                                <button onClick={handleExportCSV} className="p-2"><Download size={24} /></button>
                                <button onClick={() => setView('settings')} className="p-2"><Settings size={24} /></button>
                                <button onClick={handleLogout} className="p-2"><LogOut size={24} /></button>
                            </div>
                        </div>
                        <div className="flex gap-2 items-center relative">
                            <div className="relative flex-1"><Search className="absolute left-3 top-3 text-blue-200" size={20} /><input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="搜尋..." className="w-full bg-blue-700/50 text-white placeholder-blue-200 rounded-xl py-3 pl-10 outline-none" /></div>
                            <div className="bg-blue-500 p-3 rounded-xl cursor-pointer" onClick={() => { setScanCallback('search'); setView('scan'); }}><Barcode className="text-white" size={24} /></div>
                        </div>
                    </div>

                    <div className="p-4 space-y-4">
                        {products.length === 0 ? <div className="text-center py-20 text-gray-400"><Barcode size={48} className="mx-auto opacity-20 mb-4" /><p>暫無商品</p></div> : 
                            products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()) || p.barcode.includes(searchTerm)).map(p => (
                                <ProductCard key={p.id} product={p} onClick={() => { setCurrentProduct(p); setView('detail'); }} />
                            ))
                        }
                    </div>

                    <button onClick={() => { setCurrentProduct({name:'', barcode:generateRandomBarcode(), platforms:[{name:'蝦皮',price:''},{name:'FB',price:''},{name:'現場',price:''}], customFields:[]}); setView('edit'); }} className="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center z-30"><Plus size={28} /></button>
                    
                    {/* Detail View Overlay */}
                    {view === 'detail' && currentProduct && (
                        <div className="fixed inset-0 z-40 bg-gray-50 flex flex-col overflow-auto">
                           <div className="w-full h-64 bg-gray-200 relative"><img src={currentProduct.image} className="w-full h-full object-cover" /><button onClick={()=>setView('list')} className="absolute top-4 left-4 p-2 bg-white rounded-full"><ArrowLeft /></button><button onClick={()=>setView('edit')} className="absolute top-4 right-4 p-2 bg-blue-600 text-white rounded-full">編輯</button></div>
                           <div className="p-6 bg-white rounded-t-3xl -mt-6 flex-1 shadow-lg">
                               <h1 className="text-2xl font-bold mb-2">{currentProduct.name}</h1>
                               <div className="flex gap-2 text-gray-500 mb-4 items-center"><Barcode /> {currentProduct.barcode}</div>
                               {currentProduct.description && <div className="bg-purple-50 p-4 rounded-xl mb-6 text-sm whitespace-pre-wrap">{currentProduct.description}</div>}
                               <div className="grid grid-cols-2 gap-3 mb-6">{(currentProduct.platforms||[]).map((p,i)=><div key={i} className="bg-blue-50 p-4 rounded-xl text-center"><div className="text-blue-600 font-bold">{p.name}</div><div className="text-xl font-bold">${p.price}</div></div>)}</div>
                               <div className="bg-orange-50 p-4 rounded-xl mb-4"><div className="flex justify-between font-bold text-orange-800"><span>上次售價</span><span>${currentProduct.lastSoldPrice||0}</span></div>{currentProduct.lastSoldNote && <div className="text-sm mt-2 pt-2 border-t border-orange-200">{currentProduct.lastSoldNote}</div>}</div>
                               <div className="space-y-2">{(currentProduct.customFields||[]).map((f,i)=><div key={i} className="flex justify-between bg-gray-50 p-3 rounded-lg"><span className="text-gray-500">{f.label}</span><span className="font-bold">{f.value}</span></div>)}</div>
                           </div>
                        </div>
                    )}

                    {/* Edit View Overlay */}
                    {view === 'edit' && currentProduct && (
                        <div className="fixed inset-0 z-40 bg-gray-50 flex flex-col overflow-auto pb-20">
                            <div className="bg-white p-4 shadow-sm sticky top-0 z-10 flex justify-between items-center">
                                <button onClick={()=>setView('list')}><ArrowLeft className="text-gray-500"/></button><h1 className="font-bold">編輯商品</h1><button onClick={handleSave} disabled={loading} className="text-blue-600 font-bold">{loading?'儲存中':'完成'}</button>
                            </div>
                            <div className="p-4 space-y-6">
                                <div className="flex flex-col items-center gap-2">
                                    <div className="w-32 h-32 bg-gray-200 rounded-xl overflow-hidden relative border-2 border-dashed">{currentProduct.image ? <img src={currentProduct.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center"><Camera /></div>}<input type="file" accept="image/*" onChange={handleImg} className="absolute inset-0 opacity-0" /></div>
                                    <button onClick={handleAIIdentify} disabled={aiLoading} className="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full flex items-center gap-1"><Sparkles size={12}/> {aiLoading?'辨識中...':'AI 辨識名稱'}</button>
                                </div>
                                <div className="bg-white p-4 rounded-xl space-y-4">
                                    <input value={currentProduct.name} onChange={e=>setCurrentProduct({...currentProduct, name:e.target.value})} className="w-full p-3 bg-gray-50 rounded-lg outline-none" placeholder="商品名稱" />
                                    <div className="flex gap-2"><input value={currentProduct.barcode} onChange={e=>setCurrentProduct({...currentProduct, barcode:e.target.value})} className="flex-1 p-3 bg-gray-50 rounded-lg outline-none" /><button onClick={()=>{setScanCallback('edit');setView('scan')}} className="p-3 bg-gray-800 text-white rounded-lg"><Barcode/></button></div>
                                </div>
                                <div className="bg-white p-4 rounded-xl">
                                    <div className="flex justify-between mb-2"><label>文案</label><button onClick={handleAIGenerateDesc} className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded flex gap-1"><Wand size={12}/> AI 生成</button></div>
                                    <textarea value={currentProduct.description||''} onChange={e=>setCurrentProduct({...currentProduct, description:e.target.value})} className="w-full p-3 bg-gray-50 rounded-lg h-24 outline-none" placeholder="銷售文案..." />
                                </div>
                                <div className="bg-white p-4 rounded-xl space-y-2">
                                    <div className="flex justify-between"><h3 className="font-bold">平台價格</h3><button onClick={()=>setCurrentProduct({...currentProduct, platforms:[...currentProduct.platforms,{name:'',price:''}]})} className="text-blue-600 text-sm"><Plus size={16}/></button></div>
                                    {currentProduct.platforms.map((p,i)=><div key={i} className="flex gap-2"><input value={p.name} onChange={e=>{const n=[...currentProduct.platforms];n[i].name=e.target.value;setCurrentProduct({...currentProduct,platforms:n})}} className="flex-1 p-2 bg-gray-50 rounded" placeholder="平台" /><input type="number" value={p.price} onChange={e=>{const n=[...currentProduct.platforms];n[i].price=e.target.value;setCurrentProduct({...currentProduct,platforms:n})}} className="w-24 p-2 bg-gray-50 rounded" placeholder="$" /><button onClick={()=>setCurrentProduct({...currentProduct,platforms:currentProduct.platforms.filter((_,idx)=>idx!==i)})} className="text-red-400"><X size={16}/></button></div>)}
                                </div>
                                <div className="bg-white p-4 rounded-xl space-y-2">
                                    <label>上次售出</label><div className="flex gap-2"><input type="number" value={currentProduct.lastSoldPrice} onChange={e=>setCurrentProduct({...currentProduct, lastSoldPrice:e.target.value})} className="flex-1 p-3 bg-gray-50 rounded" placeholder="$" /><input value={currentProduct.lastSoldNote||''} onChange={e=>setCurrentProduct({...currentProduct, lastSoldNote:e.target.value})} className="flex-[2] p-3 bg-gray-50 rounded" placeholder="備註" /></div>
                                </div>
                                {currentProduct.id && <button onClick={()=>handleDelete(currentProduct.id)} className="w-full py-3 text-red-600 font-bold bg-white rounded-xl">刪除商品</button>}
                            </div>
                        </div>
                    )}
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>