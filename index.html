<!-- 
    =======================================================
    ğŸš€ æŒä¸Šåº«å­˜ç³»çµ± v3.18.7 (ç›´è¦ºæ”¹åå„ªåŒ–ç‰ˆ)
    =======================================================
    
    æ›´æ–°èªªæ˜ï¼š
    1. âœï¸ ç›´è¦ºå¼æ”¹å (Settings)ï¼š
       - æ¢å¾©ã€Œå…¬å¸ä»£ç¢¼ã€æ¬„ä½ç‚ºå¯ç›´æ¥ç·¨è¼¯ã€‚
       - ç§»é™¤è¤‡é›œçš„ã€Œè³‡æ–™æ¬ç§»ã€ç¨ç«‹å€å¡Šã€‚
       - ç•¶æ‚¨ä¿®æ”¹ä»£ç¢¼ä¸¦å„²å­˜æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•è©¢å•ï¼šã€Œæ‚¨æ˜¯è¦å¹«å…¬å¸æ”¹å(å¸¶èµ°è³‡æ–™)ï¼Œé‚„æ˜¯åˆ‡æ›å¸³è™Ÿï¼Ÿã€ï¼Œæ“ä½œæ›´ç¬¦åˆç›´è¦ºã€‚
    2. ğŸ› ï¸ æ ¸å¿ƒåŠŸèƒ½ä¿ç•™ï¼š
       - ä¿ç•™ Excel æ­£è¦åŒ¯å‡º (.xlsx)ã€ä¸‹æ‹‰é¸å–®åˆ†é¡ã€åœ–ç‰‡å£“ç¸®ç­‰æ‰€æœ‰å„ªåŒ–åŠŸèƒ½ã€‚
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŒä¸Šåº«å­˜ç³»çµ±</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <!-- Scanner & Barcode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- SheetJS for proper Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .ios-input { -webkit-appearance: none; }
        @keyframes fade-in-up { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .toast-enter { animation: fade-in-up 0.3s ease-out forwards; }
        @keyframes shine { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        .ai-gradient { background: linear-gradient(to right, #4f46e5, #9333ea, #4f46e5); background-size: 200% auto; animation: shine 3s linear infinite; }
        
        .modal-scroll { -webkit-overflow-scrolling: touch; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        
        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose strong { color: #4f46e5; }
        .dark .prose strong { color: #818cf8; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // âš ï¸ é–‹ç™¼è€…è«‹æ³¨æ„ï¼šè«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„è¨­å®š âš ï¸
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyCNWEhdhzW77Nb-aixJpSXfS5bYhmDGhao",
            authDomain: "my-shop-db-90cb9.firebaseapp.com",
            projectId: "my-shop-db-90cb9",
            storageBucket: "my-shop-db-90cb9.firebasestorage.app",
            messagingSenderId: "226456664910",
            appId: "1:226456664910:web:b5eae51dfeff46ef123c1f",
            measurementId: "G-JF5GGXED97"
        };

        const activeConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : firebaseConfig;

        // ==========================================
        // ğŸš€ æ‡‰ç”¨ç¨‹å¼é‚è¼¯é–‹å§‹
        // ==========================================

        let auth, db;
        let isConfigured = false;
        
        try {
            if (activeConfig.apiKey && activeConfig.apiKey !== "è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„apiKey") {
                if (!firebase.apps.length) firebase.initializeApp(activeConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isConfigured = true;
            }
        } catch (e) { console.error("Firebase init failed:", e); }

        // --- LocalDB ---
        const LocalDB = {
            getKey: (collection) => `local_db_${collection}`,
            getAll: (collection) => {
                const data = localStorage.getItem(LocalDB.getKey(collection));
                return data ? JSON.parse(data) : [];
            },
            saveAll: (collection, items) => {
                localStorage.setItem(LocalDB.getKey(collection), JSON.stringify(items));
            },
            add: (collection, item) => {
                const items = LocalDB.getAll(collection);
                const newItem = { ...item, id: 'local_' + Date.now(), timestamp: { seconds: Date.now() / 1000 } };
                items.unshift(newItem);
                LocalDB.saveAll(collection, items);
                return newItem;
            },
            update: (collection, id, updates) => {
                const items = LocalDB.getAll(collection);
                const index = items.findIndex(i => i.id === id);
                if (index !== -1) {
                    items[index] = { ...items[index], ...updates };
                    LocalDB.saveAll(collection, items);
                }
            },
            delete: (collection, id) => {
                const items = LocalDB.getAll(collection);
                const newItems = items.filter(i => i.id !== id);
                LocalDB.saveAll(collection, newItems);
            }
        };

        // --- Icons ---
        const Icons = {
            Camera: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>),
            Barcode: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></svg>),
            Plus: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>),
            Search: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>),
            ArrowLeft: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>),
            ImageIcon: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>),
            X: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>),
            AlertCircle: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>),
            Sparkles: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>),
            Wand: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>),
            Download: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>),
            LogOut: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>),
            User: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>),
            Settings: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>),
            Users: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>),
            Key: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>),
            GoogleLogo: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className}><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>),
            Moon: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>),
            Calendar: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>),
            Clock: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>),
            Tag: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>),
            Edit2: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>),
            Trash2: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>),
            Brain: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 16v-4"/><path d="M12 8h.01"/><path d="M20.8 10.2a5.5 5.5 0 0 0-8.8-7.2 5.5 5.5 0 0 0-8.8 7.2c-1.2 1.6-1.2 3.8 0 5.4a5.5 5.5 0 0 0 8.8 7.2 5.5 5.5 0 0 0 8.8-7.2c1.2-1.6 1.2-3.8 0-5.4Z"/></svg>),
            DollarSign: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>),
            Archive: ({size=24, className=""}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>)
        };
        const { Camera, Barcode, Plus, Search, ArrowLeft, ImageIcon, X, AlertCircle, Sparkles, Wand, Download, LogOut, User, Settings, Users, Key, GoogleLogo, Moon, Calendar, Clock, Tag, Edit2, Trash2, Brain, DollarSign, Archive } = Icons;

        // --- Utils & AI ---
        const callGemini = async (prompt, imageBase64 = null, apiKey = null) => {
            if(!apiKey) return "è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å…¥ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const parts = [{ text: prompt }];
            if (imageBase64) {
                const base64Data = imageBase64.replace(/^data:image\/(png|jpeg|jpg);base64,/, '');
                parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Data } });
            }
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts }] }) });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI ç„¡æ³•ç”¢ç”Ÿå›æ‡‰";
            } catch (error) { throw error; }
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
                reader.onerror = reject;
            });
        };

        const generateRandomBarcode = () => Math.floor(100000000000 + Math.random() * 900000000000).toString();

        // --- Components ---
        const Toast = ({ message, type = 'info', onClose }) => {
            React.useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            const bgClass = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-gray-800';
            return (
                <div className={`fixed bottom-20 left-1/2 transform -translate-x-1/2 ${bgClass} text-white px-6 py-3 rounded-full shadow-xl z-50 toast-enter flex items-center gap-2 whitespace-nowrap`}>
                    {type === 'error' && <AlertCircle size={18} />} {type === 'magic' && <Sparkles size={18} className="text-yellow-300" />} <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const BarcodeDisplay = ({ value }) => {
            const svgRef = React.useRef(null);
            React.useEffect(() => {
                if (svgRef.current && value) try { JsBarcode(svgRef.current, value, { format: "CODE128", lineColor: "#000", width: 2, height: 60, displayValue: true }); } catch (e) {}
            }, [value]);
            return <svg ref={svgRef} className="w-full h-auto max-w-[200px]"></svg>;
        };

        const Scanner = ({ onScan, onClose, onError }) => {
            React.useEffect(() => {
                const html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
                    (decodedText) => { html5QrCode.stop().then(() => onScan(decodedText)); }, () => {}
                ).catch(err => { if (onError) onError("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ (è«‹ç¢ºä¿åœ¨ HTTPS ç¶²å€æˆ– Localhost ä¸‹åŸ·è¡Œ)"); });
                return () => { if(html5QrCode.isScanning) html5QrCode.stop().catch(e=>{}); };
            }, []);
            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col justify-center items-center">
                    <div className="text-white mb-4 text-lg font-bold">æƒæå•†å“æ¢ç¢¼</div>
                    <div id="reader" className="w-full max-w-sm bg-black"></div>
                    <button onClick={onClose} className="mt-8 px-6 py-3 bg-red-600 text-white rounded-full font-bold shadow-lg">é—œé–‰ç›¸æ©Ÿ</button>
                </div>
            );
        };

        const ProductCard = ({ product, onClick }) => {
            const getLatestPrice = () => {
                if (product.salesHistory && product.salesHistory.length > 0) return product.salesHistory[0].price;
                return product.lastSoldPrice || 0;
            };
            const latestPrice = getLatestPrice();
            
            // Stock Color Logic
            const stock = product.stock || 0;
            const stockColor = stock > 0 
                ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' 
                : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300';

            return (
                <div onClick={onClick} className="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-xl shadow-sm p-4 flex items-center gap-4 active:bg-gray-50 dark:active:bg-slate-700 hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors cursor-pointer border border-gray-100 relative overflow-hidden h-full group">
                    {product.description && <div className="absolute top-0 right-0 w-3 h-3 bg-purple-400 rounded-bl-lg"></div>}
                    <div className="w-20 h-20 bg-gray-100 dark:bg-slate-700 rounded-lg flex-shrink-0 overflow-hidden relative group-hover:scale-105 transition-transform duration-300">
                        {product.image ? <img src={product.image} className="w-full h-full object-cover" /> : <ImageIcon className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500" size={24} />}
                    </div>
                    <div className="flex-1 min-w-0">
                        <h3 className="font-bold text-gray-800 dark:text-white text-lg truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">{product.name}</h3>
                        <div className="flex justify-between items-center mt-1">
                            <p className="text-gray-500 dark:text-slate-400 text-sm flex items-center gap-1"><Barcode size={14} /> {product.barcode}</p>
                            <div className="flex gap-1">
                                <span className={`text-[10px] px-2 py-0.5 rounded-full flex items-center gap-1 font-bold ${stockColor}`}>
                                    <Archive size={10}/> åº«å­˜: {stock}
                                </span>
                                {product.category && <span className="text-[10px] px-2 py-0.5 bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 rounded-full flex items-center gap-1"><Tag size={10}/>{product.category}</span>}
                            </div>
                        </div>
                        <div className="mt-2 flex flex-col gap-1">
                            <div className="flex justify-between items-end">
                                <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar max-w-[60%]">
                                    {product.platforms && product.platforms.length > 0 ? product.platforms.map((p, idx) => (<span key={idx} className="bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs px-2 py-1 rounded-md whitespace-nowrap">{p.name}: ${p.price}</span>)) : <span className="text-gray-400 dark:text-slate-500 text-xs">ç„¡åƒ¹æ ¼è¨­å®š</span>}
                                </div>
                                <div className="text-right">
                                    <div className="text-xs text-gray-400 dark:text-slate-500">ä¸Šæ¬¡æˆäº¤</div>
                                    <div className="font-bold text-orange-600 dark:text-orange-400">${latestPrice}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ... (LoginScreen & SettingsView same as v3.16)
        const LoginScreen = ({ onLogin, onRegister, onGoogleLogin, onDemoLogin }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [mode, setMode] = React.useState('login');
            if (!isConfigured) return <div className="min-h-screen bg-gray-100 flex flex-col justify-center items-center p-6 text-center"><div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full"><div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><Settings size={32}/></div><h2 className="text-xl font-bold mb-2">é–‹ç™¼è€…è¨­å®šæœªå®Œæˆ</h2><button onClick={onDemoLogin} className="w-full py-3 bg-gray-100 rounded-lg font-bold mb-4">ğŸ‘€ è¨ªå®¢è©¦ç”¨</button></div></div>;
            return <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-700 flex flex-col justify-center items-center p-6 text-white"><div className="w-full max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 text-gray-800 dark:text-white"><div className="text-center mb-8"><h2 className="text-2xl font-bold">æ­¡è¿ä½¿ç”¨æŒä¸Šåº«å­˜</h2></div><div className="mb-6 space-y-3"><button onClick={onGoogleLogin} className="w-full py-3 bg-white border border-gray-300 rounded-lg font-bold flex items-center justify-center gap-3 text-gray-700"><GoogleLogo size={20} /> ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button><button onClick={onDemoLogin} className="w-full py-3 bg-gray-50 text-gray-500 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">ğŸ‘€ è¨ªå®¢è©¦ç”¨</button></div><form onSubmit={e=>{e.preventDefault();setLoading(true);(mode==='login'?onLogin:onRegister)(email,password).finally(()=>setLoading(false))}} className="space-y-4"><div><label className="block text-sm font-medium mb-1">Email</label><input type="text" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-lg" required /></div><div><label className="block text-sm font-medium mb-1">å¯†ç¢¼</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-lg" required minLength="6" /></div><button type="submit" disabled={loading} className="w-full py-3 text-white rounded-lg font-bold bg-blue-600 hover:bg-blue-700">{loading?'...':(mode==='login'?'ç™»å…¥':'è¨»å†Š')}</button></form><div className="mt-6 text-center text-sm"><button onClick={()=>setMode(mode==='login'?'register':'login')} className="text-blue-600 font-bold hover:underline">{mode==='login'?'å…è²»è¨»å†Š':'ç›´æ¥ç™»å…¥'}</button></div></div></div>;
        };

        const SettingsView = ({ companyId, setCompanyId, onClose, userEmail, apiKey, setApiKey, isDarkMode, toggleDarkMode, isDemoMode, onSaveSettings }) => {
            const [tempId, setTempId] = React.useState(companyId || '');
            const [tempKey, setTempKey] = React.useState(apiKey || '');

            return <div className="min-h-screen bg-gray-100 dark:bg-slate-900 flex flex-col items-center"><div className="w-full max-w-2xl bg-white dark:bg-slate-800 min-h-screen shadow-2xl md:min-h-0 md:h-auto md:my-10 md:rounded-2xl overflow-hidden"><div className="bg-white dark:bg-slate-800 p-4 shadow-sm flex items-center gap-3 border-b dark:border-slate-700"><button onClick={onClose}><ArrowLeft/></button><h1 className="text-lg font-bold dark:text-white">è¨­å®š</h1></div><div className="p-6 space-y-6"><div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border dark:border-slate-700 flex justify-between items-center"><h2 className="text-sm font-bold dark:text-slate-200 flex items-center gap-2"><Moon size={16}/> å¤œé–“æ¨¡å¼</h2><button onClick={toggleDarkMode} className={`w-12 h-6 rounded-full p-1 transition-colors ${isDarkMode?'bg-blue-600':'bg-gray-300'}`}><div className={`w-4 h-4 bg-white rounded-full transform transition-transform ${isDarkMode?'translate-x-6':'translate-x-0'}`}></div></button></div><div className="p-4 rounded-xl shadow-sm border dark:border-slate-700"><h2 className="text-sm font-bold mb-4 flex items-center gap-2 dark:text-white"><User size={16}/> å¸³è™Ÿ</h2><div className="text-lg font-medium dark:text-white">{userEmail}</div></div>
            
            <div className="p-4 rounded-xl shadow-sm border dark:border-slate-700">
                <h2 className="text-sm font-bold mb-4 flex items-center gap-2 text-blue-600"><Users size={16}/> å•†åº—åç¨± / å…¬å¸ä»£ç¢¼</h2>
                <input 
                    value={tempId} 
                    onChange={e=>setTempId(e.target.value)} 
                    className="w-full p-3 bg-gray-50 dark:bg-slate-700 border rounded-lg dark:text-white" 
                    placeholder="ä¾‹å¦‚ï¼šMyCoffeeShop"
                />
                <div className="mt-2 text-xs text-gray-400">æ‚¨å¯ä»¥ç›´æ¥ä¿®æ”¹ä¸Šæ–¹åç¨±ä¾†ç‚ºå•†åº—æ”¹åï¼Œç³»çµ±æœƒè©¢å•æ˜¯å¦æ¬ç§»è³‡æ–™ã€‚</div>
            </div>

            <div className="p-4 rounded-xl shadow-sm border dark:border-slate-700"><h2 className="text-sm font-bold mb-4 flex items-center gap-2 text-purple-600"><Key size={16}/> Gemini API (AI åŠŸèƒ½)</h2><input type="password" value={tempKey} onChange={e=>setTempKey(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-slate-700 border rounded-lg dark:text-white" placeholder="AIzaSy..."/><p className="text-xs text-gray-500 mt-2">è«‹è²¼ä¸Šæ‚¨çš„ Google Gemini API Key ä»¥å•Ÿç”¨ AI åŠŸèƒ½ã€‚</p></div><button onClick={()=>{ onSaveSettings(tempId.trim(), tempKey.trim()); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">å„²å­˜è¨­å®š</button></div></div></div>;
        };

        const CategoryManager = ({ categories, products, onRename, onDelete, onClose, onAdd }) => {
            const [editTarget, setEditTarget] = React.useState(null);
            const [newName, setNewName] = React.useState('');
            const [addName, setAddName] = React.useState('');
            const handleAdd = () => { if(addName && !categories.includes(addName)) { onAdd(addName); setAddName(''); } };
            return <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden max-h-[80vh] flex flex-col"><div className="p-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center bg-gray-50 dark:bg-slate-900/50"><h3 className="font-bold text-lg dark:text-white flex items-center gap-2"><Tag size={20} className="text-blue-600"/> åˆ†é¡ç®¡ç†</h3><button onClick={onClose}><X className="text-gray-500"/></button></div><div className="p-4 border-b border-gray-100 dark:border-slate-700 bg-blue-50/50 dark:bg-blue-900/10"><div className="flex gap-2"><input value={addName} onChange={e => setAddName(e.target.value)} className="flex-1 px-3 py-2 border border-blue-200 dark:border-blue-800 rounded-lg dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±..." /><button onClick={handleAdd} disabled={!addName} className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white px-4 py-2 rounded-lg font-bold shadow-sm transition-colors whitespace-nowrap">æ–°å¢</button></div></div><div className="p-4 overflow-y-auto flex-1 space-y-2">{categories.filter(c => c !== 'å…¨éƒ¨').map(cat => { const count = products.filter(p => p.category === cat).length; return (<div key={cat} className="flex items-center justify-between p-3 bg-white dark:bg-slate-700 border border-gray-100 dark:border-slate-600 rounded-xl">{editTarget === cat ? (<div className="flex-1 flex gap-2"><input autoFocus value={newName} onChange={e => setNewName(e.target.value)} className="flex-1 px-2 py-1 border rounded dark:bg-slate-600 dark:text-white" placeholder="æ–°åç¨±" /><button onClick={() => { onRename(cat, newName); setEditTarget(null); }} className="bg-green-500 text-white px-3 rounded text-sm">OK</button><button onClick={() => setEditTarget(null)} className="bg-gray-300 text-gray-700 px-3 rounded text-sm">å–æ¶ˆ</button></div>) : (<><div className="flex-1"><span className="font-bold text-gray-800 dark:text-white">{cat}</span><span className={`ml-2 text-xs px-2 py-0.5 rounded-full ${count > 0 ? 'bg-gray-100 dark:bg-slate-600 text-gray-500 dark:text-slate-300' : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400'}`}>{count > 0 ? `${count} é …` : 'è‡ªè¨‚/ç„¡å•†å“'}</span></div><div className="flex gap-1"><button onClick={() => { setEditTarget(cat); setNewName(cat); }} className="p-2 text-blue-500 hover:bg-blue-50 dark:hover:bg-slate-600 rounded"><Edit2 size={16}/></button><button onClick={() => onDelete(cat)} className="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-slate-600 rounded"><Trash2 size={16}/></button></div></>)}</div>); })}</div></div></div>;
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('list'); 
            const [products, setProducts] = React.useState([]);
            const [currentProduct, setCurrentProduct] = React.useState(null);
            const [scanCallback, setScanCallback] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [aiLoading, setAiLoading] = React.useState(false); 
            const [searchTerm, setSearchTerm] = React.useState('');
            const [toast, setToast] = React.useState(null);
            const [companyId, setCompanyIdState] = React.useState(() => localStorage.getItem('inventory_company_id') || '');
            const [apiKey, setApiKeyState] = React.useState(() => localStorage.getItem('inventory_api_key') || '');
            const [isDemoMode, setIsDemoMode] = React.useState(false);
            const [isDarkMode, setIsDarkMode] = React.useState(() => localStorage.getItem('inventory_dark_mode') === 'true');
            const [selectedCategory, setSelectedCategory] = React.useState('å…¨éƒ¨');
            const [showCatManager, setShowCatManager] = React.useState(false);
            const [newHistory, setNewHistory] = React.useState({ date: new Date().toISOString().split('T')[0], price: '', note: '' });
            const [manualCats, setManualCats] = React.useState(() => { try { return JSON.parse(localStorage.getItem('inventory_custom_cats') || '[]'); } catch { return []; } });

            React.useEffect(() => { if (isDarkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); localStorage.setItem('inventory_dark_mode', isDarkMode); }, [isDarkMode]);
            const setCompanyId = (id) => { setCompanyIdState(id); localStorage.setItem('inventory_company_id', id); showToast(id ? `å·²åˆ‡æ›è‡³: ${id}` : "å·²åˆ‡æ›å›å€‹äººæ¨¡å¼", "success"); };
            const setApiKey = (key) => { setApiKeyState(key); localStorage.setItem('inventory_api_key', key); };
            const showToast = (message, type = 'info') => setToast({ message, type });

            const categories = React.useMemo(() => { const productCats = new Set(products.map(p => p.category || 'æœªåˆ†é¡').filter(c => c)); const all = new Set([...productCats, ...manualCats]); return ['å…¨éƒ¨', ...Array.from(all).sort()]; }, [products, manualCats]);

            React.useEffect(() => { if (isConfigured && auth) { const unsubscribe = auth.onAuthStateChanged((u) => setUser(u)); return () => unsubscribe(); } }, []);
            React.useEffect(() => { if (!user) { setProducts([]); return; } if (isConfigured && !isDemoMode) { const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app'; let q; if (companyId) { q = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory').where('companyId', '==', companyId); } else { q = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('products').orderBy('timestamp', 'desc'); } const unsubscribe = q.onSnapshot((snapshot) => { let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (companyId) items.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); setProducts(items); }, (error) => showToast("è®€å–å¤±æ•—", "error")); return () => unsubscribe(); } else { const collectionKey = companyId ? `shared_${companyId}` : `user_${user.uid}`; const items = LocalDB.getAll(collectionKey); if (items.length === 0) { const demoItem = { id: 'demo_1', name: 'ç¯„ä¾‹å•†å“ (iPhone 15)', barcode: '123456789', category: 'é›»å­ç”¢å“', platforms: [{name:'è¦çš®', price: 30000}], lastSoldPrice: 29000, stock: 10, description: 'é€™æ˜¯ä¸€ç­†ç¯„ä¾‹è³‡æ–™', timestamp: {seconds: Date.now()/1000}, lastEditor: 'DemoUser', aiAnalysis: "å°šç„¡åˆ†æè³‡æ–™" }; LocalDB.add(collectionKey, demoItem); setProducts([demoItem]); } else { setProducts(items); } } }, [user, companyId, view, isDemoMode]);

            const handleLogin = async (email, password) => { if (isConfigured) { try { await auth.signInWithEmailAndPassword(email, password); showToast("ç™»å…¥æˆåŠŸï¼"); } catch (e) { showToast("ç™»å…¥å¤±æ•—: " + e.message, "error"); } } };
            const handleDemoLogin = () => { const demoUser = { uid: "demo_user", email: "guest@demo.com", displayName: "è¨ªå®¢" }; setIsDemoMode(true); setUser(demoUser); showToast("å·²é€²å…¥æ¼”ç¤ºæ¨¡å¼", "success"); };
            const handleGoogleLogin = async () => { if (!isConfigured) return; const provider = new firebase.auth.GoogleAuthProvider(); try { await auth.signInWithPopup(provider); showToast("Google ç™»å…¥æˆåŠŸï¼"); } catch (error) { showToast("ç™»å…¥å¤±æ•—", "error"); } };
            const handleRegister = async (email, password) => { try { await auth.createUserWithEmailAndPassword(email, password); showToast("è¨»å†ŠæˆåŠŸï¼"); } catch (e) { showToast("è¨»å†Šå¤±æ•—: " + e.message, "error"); } };
            const handleLogout = async () => { if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) { if (isConfigured && !isDemoMode) await auth.signOut(); setUser(null); setIsDemoMode(false); showToast("å·²ç™»å‡º"); } };
            
            const handleAIIdentify = async () => { if (!currentProduct.image) return showToast("è«‹å…ˆä¸Šå‚³ç…§ç‰‡", "error"); setAiLoading(true); try { const res = await callGemini("è«‹è¾¨è­˜æ­¤å•†å“åç¨±ï¼Œåªå›å‚³åç¨±ï¼Œä¸è¦å¤šé¤˜æ–‡å­—ã€‚", currentProduct.image, apiKey); setCurrentProduct(prev => ({ ...prev, name: res.trim() })); showToast("è¾¨è­˜æˆåŠŸï¼", "magic"); } catch (e) { showToast("API Key éŒ¯èª¤æˆ–é¡åº¦ä¸è¶³", "error"); } setAiLoading(false); };
            const handleAIGenerateDesc = async () => { if (!currentProduct.name) return showToast("è«‹å…ˆè¼¸å…¥åç¨±", "error"); setAiLoading(true); try { const res = await callGemini(`ä½ æ˜¯å°ˆæ¥­å°ç·¨ã€‚è«‹ç‚ºã€Œ${currentProduct.name}ã€å¯«ä¸€æ®µ 100 å­—å…§çš„ FB éŠ·å”®è²¼æ–‡ï¼Œèªæ°£æ´»æ½‘ã€åŠ å…¥ emojiã€‚`, currentProduct.image, apiKey); setCurrentProduct(prev => ({ ...prev, description: res })); showToast("ç”ŸæˆæˆåŠŸï¼", "magic"); } catch (e) { showToast("API Key éŒ¯èª¤æˆ–é¡åº¦ä¸è¶³", "error"); } setAiLoading(false); };
            const handleAISalesStrategy = async () => { if (!currentProduct.name) return showToast("è«‹å…ˆè¼¸å…¥åç¨±", "error"); setAiLoading(true); try { const prompt = `ä½ æ˜¯å°ˆæ¥­é›»å•†é¡§å•ã€‚è«‹åˆ†æå•†å“ã€Œ${currentProduct.name}ã€${currentProduct.description ? `(æè¿°ï¼š${currentProduct.description})` : ""}ã€‚è«‹æä¾›å°ç£å¸‚å ´çš„éŠ·å”®ç­–ç•¥ï¼š\n1. ğŸ¯ ç›®æ¨™å®¢ç¾¤ (3é»)\n2. ğŸ”¥ éŠ·å”®äº®é» (3é»)\n3. ğŸ·ï¸ æ¨è–¦ Hashtags (5å€‹)\nè«‹ç”¨ Markdown æ ¼å¼èˆ‡ç¹é«”ä¸­æ–‡æ¸…æ¥šå‘ˆç¾ã€‚`; const res = await callGemini(prompt, currentProduct.image, apiKey); const newProduct = { ...currentProduct, aiAnalysis: res }; setCurrentProduct(newProduct); if (isConfigured && !isDemoMode) { const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app'; let ref = companyId ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory') : db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('products'); await ref.doc(newProduct.id).update({ aiAnalysis: res }); } else { const collection = companyId ? `shared_${companyId}` : `user_${user.uid}`; LocalDB.update(collection, newProduct.id, { aiAnalysis: res }); } showToast("ç­–ç•¥ç”ŸæˆæˆåŠŸä¸¦å·²å„²å­˜ï¼", "magic"); } catch (e) { showToast("API Key éŒ¯èª¤", "error"); } setAiLoading(false); };
            const handleAIPriceEstimate = async () => { if (!currentProduct.name) return showToast("è«‹å…ˆè¼¸å…¥åç¨±", "error"); setAiLoading(true); try { const res = await callGemini(`å•†å“ï¼šã€Œ${currentProduct.name}ã€ã€‚è«‹æ ¹æ“šä¸€èˆ¬å°ç£å¸‚å ´è¡Œæƒ…ï¼Œæä¾›ä¸€å€‹åˆç†çš„å”®åƒ¹å€é–“ (TWD)ï¼Œä¸¦ç°¡è¿°ç†ç”±(20å­—å…§)ã€‚è«‹ç›´æ¥å›å‚³ç´”æ–‡å­—ï¼Œä¾‹å¦‚ï¼šã€å»ºè­° $500-$600ï¼Œå¸‚å ´å‡åƒ¹ã€ã€‚`, currentProduct.image, apiKey); alert(`ğŸ’° AI ä¼°åƒ¹å»ºè­°ï¼š\n\n${res}`); } catch (e) { showToast("API Key éŒ¯èª¤", "error"); } setAiLoading(false); };
            const handleAICategorySuggest = async () => { if (!currentProduct.name) return showToast("è«‹å…ˆè¼¸å…¥åç¨±", "error"); setAiLoading(true); try { const res = await callGemini(`å•†å“ï¼šã€Œ${currentProduct.name}ã€ã€‚è«‹ç›´æ¥æä¾›ä¸€å€‹æœ€é©åˆçš„åˆ†é¡åç¨±(ä¾‹å¦‚ï¼š3Cã€é£Ÿå“ã€æœé£¾)ï¼Œåªå›å‚³åˆ†é¡åç¨±ï¼Œä¸è¦æœ‰æ¨™é»ç¬¦è™Ÿã€‚`, currentProduct.image, apiKey); setCurrentProduct(prev => ({ ...prev, category: res.trim() })); showToast(`å·²å»ºè­°åˆ†é¡ï¼š${res.trim()}`, "magic"); } catch (e) { showToast("API Key éŒ¯èª¤", "error"); } setAiLoading(false); };

            const handleAddHistory = () => { if(!newHistory.price) return showToast("è«‹è¼¸å…¥å”®åƒ¹", "error"); const historyItem = { ...newHistory, id: Date.now() }; const updatedHistory = [historyItem, ...(currentProduct.salesHistory || [])].sort((a, b) => new Date(b.date) - new Date(a.date)); setCurrentProduct({ ...currentProduct, salesHistory: updatedHistory }); setNewHistory({ date: new Date().toISOString().split('T')[0], price: '', note: '' }); showToast("å·²åŠ å…¥ç´€éŒ„", "success"); };
            
            const handleSave = async () => { if (!currentProduct.name) return showToast("è«‹è¼¸å…¥åç¨±", "error"); setLoading(true); try { const editorName = user.displayName || user.email || 'user_' + user.uid.slice(0,5); const data = { ...currentProduct, lastEditor: editorName }; if (isConfigured && !isDemoMode) { const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app'; let ref = companyId ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory') : db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('products'); if (data.companyId === undefined && companyId) data.companyId = companyId; data.timestamp = firebase.firestore.FieldValue.serverTimestamp(); if (currentProduct.id) await ref.doc(currentProduct.id).update(data); else await ref.add(data); } else { const collection = companyId ? `shared_${companyId}` : `user_${user.uid}`; if (currentProduct.id) LocalDB.update(collection, currentProduct.id, data); else LocalDB.add(collection, data); setProducts(LocalDB.getAll(collection)); } showToast("å„²å­˜æˆåŠŸ", "success"); setView('list'); setCurrentProduct(null); } catch (e) { console.error(e); showToast("å„²å­˜å¤±æ•—", "error"); } setLoading(false); };
            const handleDelete = async (id) => { if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return; try { if (isConfigured && !isDemoMode) { const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app'; let ref = companyId ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory') : db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('products'); await ref.doc(id).delete(); } else { const collection = companyId ? `shared_${companyId}` : `user_${user.uid}`; LocalDB.delete(collection, id); setProducts(LocalDB.getAll(collection)); } showToast("å·²åˆªé™¤"); setView('list'); } catch(e) { showToast("åˆªé™¤å¤±æ•—", "error"); } };
            
            // New Migrate Function Integrated into Settings Save
            const handleSettingsSave = async (newId, newApiKey) => {
                setApiKey(newApiKey);
                
                // Case 1: No change in ID
                if (newId === companyId) {
                    setView('list');
                    return;
                }

                // Case 2: New ID is empty (switching to personal)
                if (!newId) {
                    setCompanyId('');
                    setView('list');
                    return;
                }

                // Case 3: ID Changed (and old ID existed) -> Ask for action
                if (companyId) {
                    if (confirm(`æ‚¨å°‡å•†åº—åç¨±å¾ã€Œ${companyId}ã€æ”¹ç‚ºã€Œ${newId}ã€ã€‚\n\nè«‹å•æ‚¨æ˜¯è¦ï¼š\n[ç¢ºå®š] æ”¹å (å°‡èˆŠè³‡æ–™æ¬ç§»éå»)\n[å–æ¶ˆ] åƒ…åˆ‡æ› (ä¿ç•™èˆŠè³‡æ–™ï¼Œåªåˆ‡æ›æŸ¥çœ‹)`)) {
                        // User chose "Rename" (Move Data)
                        await migrateData(companyId, newId);
                    } else {
                        // User chose "Switch" (Just change ID)
                        setCompanyId(newId);
                    }
                } else {
                    // Case 4: From personal to Shop ID (Just set it)
                    setCompanyId(newId);
                }
                setView('list');
            };

            const migrateData = async (oldId, newId) => {
                setLoading(true);
                try {
                    // Firebase Mode
                    if (isConfigured && !isDemoMode) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app';
                        let ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory');
                        
                        // 1. Fetch all items with old companyId
                        const snapshot = await ref.where('companyId', '==', oldId).get();
                        
                        if (snapshot.empty) {
                            showToast("èˆŠåç¨±ä¸‹æ²’æœ‰è³‡æ–™å¯æ¬ç§»", "info");
                            setCompanyId(newId);
                            setLoading(false);
                            return;
                        }

                        // 2. Batch Update (Firestore limit: 500 ops per batch)
                        const batch = db.batch();
                        let count = 0;
                        snapshot.docs.forEach(doc => {
                            if (count < 490) { // Safety buffer
                                batch.update(doc.ref, { companyId: newId });
                                count++;
                            }
                        });
                        
                        await batch.commit();
                        showToast(`æˆåŠŸæ”¹åä¸¦æ¬ç§» ${count} ç­†è³‡æ–™ï¼`, "success");
                    } else {
                        // LocalDB Mode
                        const oldCollection = `shared_${oldId}`;
                        const newCollection = `shared_${newId}`;
                        
                        const oldItems = LocalDB.getAll(oldCollection);
                        const newItems = LocalDB.getAll(newCollection);
                        
                        // Merge old items into new collection
                        const mergedItems = [...newItems, ...oldItems.map(item => ({...item, companyId: newId}))];
                        LocalDB.saveAll(newCollection, mergedItems);
                        
                        // Clear old collection
                        LocalDB.saveAll(oldCollection, []);
                        
                        showToast(`æˆåŠŸæ”¹å (æœ¬æ©Ÿ)ï¼`, "success");
                    }
                    
                    setCompanyId(newId); 
                } catch(e) {
                    showToast("æ”¹åå¤±æ•—: " + e.message, "error");
                    console.error(e);
                }
                setLoading(false);
            };

            const handleAddManualCategory = (newCat) => { const updated = [...manualCats, newCat]; setManualCats(updated); localStorage.setItem('inventory_custom_cats', JSON.stringify(updated)); showToast(`å·²æ–°å¢åˆ†é¡ï¼š${newCat}`, "success"); };
            const handleRenameCategory = async (oldName, newName) => { 
                if (!newName || newName === oldName) return; 
                const isMerge = categories.includes(newName);
                if (!confirm(isMerge ? `åˆ†é¡ã€Œ${newName}ã€å·²å­˜åœ¨ã€‚\nç¢ºå®šè¦å°‡ã€Œ${oldName}ã€åˆä½µè‡³ã€Œ${newName}ã€å—ï¼Ÿ\n(æ‰€æœ‰ã€Œ${oldName}ã€çš„å•†å“å°‡ç§»è‡³ã€Œ${newName}ã€)` : `ç¢ºå®šè¦å°‡ã€Œ${oldName}ã€æ”¹åç‚ºã€Œ${newName}ã€å—ï¼Ÿ`)) return; 
                if (manualCats.includes(oldName)) { 
                    let updated = manualCats.filter(c => c !== oldName);
                    if (!updated.includes(newName)) updated.push(newName);
                    setManualCats(updated); 
                    localStorage.setItem('inventory_custom_cats', JSON.stringify(updated)); 
                } 
                const affectedProducts = products.filter(p => p.category === oldName); 
                if (affectedProducts.length > 0) { 
                    setLoading(true); 
                    try { 
                        if (isConfigured && !isDemoMode) { 
                            const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app'; 
                            let ref = companyId ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory') : db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('products'); 
                            const batch = db.batch(); 
                            affectedProducts.forEach(p => { 
                                batch.update(ref.doc(p.id), { category: newName }); 
                            }); 
                            await batch.commit(); 
                        } else { 
                            const collection = companyId ? `shared_${companyId}` : `user_${user.uid}`; 
                            affectedProducts.forEach(p => { 
                                LocalDB.update(collection, p.id, { ...p, category: newName }); 
                            }); 
                            setProducts(LocalDB.getAll(collection)); 
                        } 
                        showToast(`å·²å°‡ ${affectedProducts.length} å€‹å•†å“ç§»è‡³ã€Œ${newName}ã€`, "success"); 
                    } catch(e) { 
                        showToast("æ›´æ–°å¤±æ•—", "error"); 
                    } 
                    setLoading(false); 
                } else {
                    showToast("åˆ†é¡åç¨±å·²æ›´æ–°", "success");
                }
            };
            
            const handleDeleteCategory = async (catName) => { if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${catName}ã€åˆ†é¡å—ï¼Ÿ`)) return; if (manualCats.includes(catName)) { const updated = manualCats.filter(c => c !== catName); setManualCats(updated); localStorage.setItem('inventory_custom_cats', JSON.stringify(updated)); } const affectedProducts = products.filter(p => p.category === catName); if (affectedProducts.length > 0) { setLoading(true); try { if (isConfigured && !isDemoMode) { const appId = typeof __app_id !== 'undefined' ? __app_id : 'inventory-app'; let ref = companyId ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shared_inventory') : db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('products'); const batch = db.batch(); affectedProducts.forEach(p => { batch.update(ref.doc(p.id), { category: '' }); }); await batch.commit(); } else { const collection = companyId ? `shared_${companyId}` : `user_${user.uid}`; affectedProducts.forEach(p => { LocalDB.update(collection, p.id, { ...p, category: '' }); }); setProducts(LocalDB.getAll(collection)); } showToast(`å·²ç§»é™¤åˆ†é¡é€£çµ`, "success"); } catch(e) { showToast("åˆªé™¤å¤±æ•—", "error"); } setLoading(false); } else { showToast("å·²åˆªé™¤åˆ†é¡æ¨™ç±¤", "success"); } };

            const handleExportExcel = () => {
                if (products.length === 0) return showToast("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º", "error");
                const allPlatformNames = new Set();
                products.forEach(p => { if (p.platforms) { p.platforms.forEach(pl => { if (pl.name) allPlatformNames.add(pl.name); }); } });
                const platformHeaders = Array.from(allPlatformNames).sort();
                const headers = ["å•†å“åç¨±", "æ¢ç¢¼ (Barcode)", "åˆ†é¡", "åº«å­˜", ...platformHeaders.map(p => `åƒ¹æ ¼ (${p})`), "æœ€æ–°æˆäº¤æ—¥æœŸ", "æœ€æ–°æˆäº¤åƒ¹", "æ­·å²æˆäº¤ç´€éŒ„"];
                const data = products.map(p => {
                    const platformPrices = platformHeaders.map(headerName => { const found = (p.platforms || []).find(pl => pl.name === headerName); return found ? found.price : ""; });
                    const hasHistory = p.salesHistory && p.salesHistory.length > 0;
                    const latestDate = hasHistory ? p.salesHistory[0].date : "-";
                    const latestPrice = hasHistory ? p.salesHistory[0].price : (p.lastSoldPrice || 0);
                    const historyStr = (p.salesHistory || []).map(h => `${h.date}: $${h.price}${h.note ? '('+h.note+')' : ''}`).join(" | ");
                    return [p.name, p.barcode, p.category, p.stock, ...platformPrices, latestDate, latestPrice, historyStr];
                });
                const wsData = [headers, ...data];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "åº«å­˜æ¸…å–®");
                XLSX.writeFile(wb, `inventory_export_${new Date().toISOString().slice(0,10)}.xlsx`);
                showToast("åŒ¯å‡º Excel (.xlsx) æˆåŠŸï¼", "success");
            };

            const filteredProducts = products.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase()) || p.barcode.includes(searchTerm);
                const matchesCategory = selectedCategory === 'å…¨éƒ¨' || (p.category || 'æœªåˆ†é¡') === selectedCategory;
                return matchesSearch && matchesCategory;
            });

            if (!user) return <><LoginScreen onLogin={handleLogin} onRegister={handleRegister} onGoogleLogin={handleGoogleLogin} onDemoLogin={handleDemoLogin} />{toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}</>;
            if (view === 'settings') return <SettingsView companyId={companyId} setCompanyId={setCompanyId} apiKey={apiKey} setApiKey={setApiKey} onClose={() => setView('list')} userEmail={user.email} isDarkMode={isDarkMode} toggleDarkMode={() => setIsDarkMode(!isDarkMode)} isDemoMode={isDemoMode} onSaveSettings={handleSettingsSave} />;
            if (view === 'scan') return <><Scanner onScan={(code)=>{ setView('list'); if (scanCallback==='edit') { setCurrentProduct(p=>({...p, barcode:code})); setView('edit'); } else { const found = products.find(p=>p.barcode===code); if(found){ setCurrentProduct(found); setView('detail'); } else if(confirm('æŸ¥ç„¡æ­¤å•†å“ï¼Œæ–°å¢å—ï¼Ÿ')) { setCurrentProduct({name:'', barcode:code, platforms:[{name:'è¦çš®',price:''},{name:'FB',price:''},{name:'ç¾å ´',price:''}], stock: 0, customFields:[], category: ''}); setView('edit'); } } setScanCallback(null); }} onClose={() => setView(scanCallback === 'edit' ? 'edit' : 'list')} />{toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}</>;

            return (
                <div className="min-h-screen pb-24 bg-gray-100 dark:bg-slate-900 transition-colors duration-300">
                    <div className="bg-blue-600 dark:bg-slate-800 text-white p-6 rounded-b-3xl md:rounded-none shadow-lg sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className="text-2xl font-bold flex items-center gap-2">åº«å­˜ {companyId && <span className="text-xs bg-blue-800 dark:bg-slate-700 px-2 py-1 rounded ml-2 hidden md:inline-block">{companyId}</span>}</h1>
                                {companyId && <span className="text-xs bg-blue-800 dark:bg-slate-700 px-2 py-1 rounded ml-2 md:hidden">{companyId}</span>}
                                <div className="flex gap-2">
                                    <button onClick={handleExportExcel} className="p-2 hover:bg-blue-700 dark:hover:bg-slate-600 rounded-full transition-colors flex items-center gap-1" title="åŒ¯å‡ºæ­£è¦ Excel (.xlsx)">
                                        <Download size={24} /> <span className="text-xs font-bold hidden md:inline">åŒ¯å‡ºExcel</span>
                                    </button>
                                    <button onClick={() => setView('settings')} className="p-2 hover:bg-blue-700 dark:hover:bg-slate-600 rounded-full transition-colors"><Settings size={24} /></button>
                                    <button onClick={handleLogout} className="p-2 hover:bg-blue-700 dark:hover:bg-slate-600 rounded-full transition-colors"><LogOut size={24} /></button>
                                </div>
                            </div>
                            <div className="flex gap-2 items-center relative mb-4">
                                <div className="relative flex-1"><Search className="absolute left-3 top-3 text-blue-200 dark:text-slate-400" size={20} /><input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="æœå°‹å•†å“åç¨±æˆ–æ¢ç¢¼..." className="w-full bg-blue-700/50 dark:bg-slate-700 text-white placeholder-blue-200 dark:placeholder-slate-400 rounded-xl py-3 pl-10 outline-none focus:ring-2 focus:ring-blue-400 dark:focus:ring-slate-500 transition-all" /></div>
                                <div className="bg-blue-500 hover:bg-blue-400 dark:bg-slate-600 dark:hover:bg-slate-500 p-3 rounded-xl cursor-pointer transition-colors" onClick={() => { setScanCallback('search'); setView('scan'); }}><Barcode className="text-white" size={24} /></div>
                            </div>
                            <div className="flex gap-2 items-center">
                                <div className="relative flex-1">
                                    <select 
                                        value={selectedCategory} 
                                        onChange={(e) => setSelectedCategory(e.target.value)}
                                        className="w-full appearance-none bg-blue-700/50 hover:bg-blue-700 dark:bg-slate-700 text-white border-0 rounded-xl py-3 pl-4 pr-10 font-bold outline-none focus:ring-2 focus:ring-white/30 transition-colors cursor-pointer"
                                    >
                                        {categories.map(cat => {
                                            const count = products.filter(p => (p.category || 'æœªåˆ†é¡') === (cat === 'å…¨éƒ¨' ? (p.category || 'æœªåˆ†é¡') : cat)).length;
                                            return (
                                                <option key={cat} value={cat} className="text-gray-900 bg-white">
                                                    {cat} {cat !== 'å…¨éƒ¨' ? `(${count})` : ''}
                                                </option>
                                            );
                                        })}
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-blue-200">
                                        <svg className="fill-current h-5 w-5" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                                    </div>
                                </div>
                                <button onClick={() => setShowCatManager(true)} className="p-3 bg-blue-700/50 hover:bg-blue-700 dark:bg-slate-700 rounded-xl text-white shadow-sm flex items-center gap-1 transition-colors whitespace-nowrap">
                                    <Edit2 size={18}/>
                                    <span className="text-sm font-bold hidden md:inline">ç®¡ç†åˆ†é¡</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 max-w-7xl mx-auto">
                        {isDemoMode && <div className="mb-4 p-3 bg-orange-100 text-orange-800 text-sm rounded-lg flex items-center justify-center gap-2 border border-orange-200"><AlertCircle size={16}/> ç›®å‰ç‚ºæ¼”ç¤ºæ¨¡å¼ï¼Œè³‡æ–™ä¸æœƒä¸Šå‚³é›²ç«¯</div>}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {filteredProducts.length === 0 ? 
                                <div className="col-span-full text-center py-20 text-gray-400 dark:text-slate-500"><Barcode size={48} className="mx-auto opacity-20 mb-4" /><p>æ²’æœ‰æ‰¾åˆ°ã€Œ{selectedCategory}ã€ç›¸é—œå•†å“</p></div> 
                                : filteredProducts.map(p => <ProductCard key={p.id} product={p} onClick={() => { setCurrentProduct(p); setView('detail'); }} />)
                            }
                        </div>
                    </div>

                    <button onClick={() => { setCurrentProduct({name:'', barcode:generateRandomBarcode(), platforms:[{name:'è¦çš®',price:''},{name:'FB',price:''},{name:'ç¾å ´',price:''}], stock: 0, customFields:[], salesHistory: [], category: ''}); setView('edit'); }} className="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-500 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center z-30 transition-transform active:scale-95"><Plus size={28} /></button>
                    
                    {/* Detail View */}
                    {view === 'detail' && currentProduct && (
                        <div className="fixed inset-0 z-40 bg-gray-50 dark:bg-slate-900 flex flex-col justify-center items-center md:bg-black/60 md:backdrop-blur-sm p-0 md:p-6">
                           <div className="w-full h-full md:w-full md:max-w-4xl md:h-[85vh] bg-white dark:bg-slate-800 md:rounded-2xl shadow-2xl flex flex-col overflow-hidden relative">
                                <div className="w-full h-64 md:h-72 bg-gray-100 dark:bg-slate-700 relative flex-shrink-0 group">
                                    <img src={currentProduct.image} className="w-full h-full object-cover" />
                                    <button onClick={()=>setView('list')} className="absolute top-4 left-4 p-2 bg-white/90 dark:bg-slate-800/90 dark:text-white hover:bg-white dark:hover:bg-slate-800 rounded-full shadow-sm transition-all"><ArrowLeft /></button>
                                    <button onClick={()=>setView('edit')} className="absolute top-4 right-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg font-bold text-sm transition-colors">ç·¨è¼¯</button>
                                </div>
                                <div className="p-6 md:p-8 flex-1 overflow-y-auto modal-scroll">
                                    <h1 className="text-2xl md:text-3xl font-bold mb-2 text-gray-800 dark:text-white">{currentProduct.name}</h1>
                                    <div className="flex gap-2 text-gray-500 dark:text-slate-400 mb-6 items-center">
                                        <Barcode /> <span className="font-mono text-lg">{currentProduct.barcode}</span>
                                        <span className={`text-xs px-2 py-1 rounded-full flex items-center gap-1 font-bold ${currentProduct.stock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}><Archive size={12}/> åº«å­˜: {currentProduct.stock || 0}</span>
                                        {currentProduct.category && <span className="text-xs px-2 py-1 bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 rounded-full flex items-center gap-1"><Tag size={12}/>{currentProduct.category}</span>}
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="space-y-6">
                                            {/* AI Sales Strategy Section */}
                                            <div className="bg-indigo-50 dark:bg-indigo-900/20 p-5 rounded-xl border border-indigo-100 dark:border-indigo-800">
                                                <div className="flex justify-between items-center mb-3">
                                                    <h3 className="text-sm font-bold text-indigo-700 dark:text-indigo-300 uppercase flex items-center gap-2"><Brain size={16}/> AI éŠ·å”®é¡§å•</h3>
                                                    <button onClick={handleAISalesStrategy} disabled={aiLoading} className={`text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-full flex items-center gap-1 transition-all shadow-sm ${aiLoading?'opacity-70 cursor-wait':''}`}>
                                                        <Sparkles size={12}/> {aiLoading ? 'åˆ†æä¸­...' : (currentProduct.aiAnalysis ? 'é‡æ–°åˆ†æ' : 'ç”Ÿæˆç­–ç•¥')}
                                                    </button>
                                                </div>
                                                {currentProduct.aiAnalysis ? (
                                                    <div className="prose prose-sm dark:prose-invert max-w-none text-gray-700 dark:text-slate-300 text-sm leading-relaxed" dangerouslySetInnerHTML={{__html: marked.parse(currentProduct.aiAnalysis)}}></div>
                                                ) : (
                                                    <div className="text-center py-6 text-gray-400 dark:text-slate-500 text-sm">
                                                        <Brain size={32} className="mx-auto mb-2 opacity-30"/>
                                                        <p>é»æ“ŠæŒ‰éˆ•ï¼Œè®“ AI ç‚ºæ­¤å•†å“<br/>é‡èº«æ‰“é€ éŠ·å”®ç­–ç•¥</p>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl">
                                                <h3 className="text-xs font-bold text-orange-600 dark:text-orange-300 uppercase mb-3 flex items-center gap-2"><Clock size={14}/> æ­·å²éŠ·å”®ç´€éŒ„</h3>
                                                {(currentProduct.salesHistory && currentProduct.salesHistory.length > 0) ? (
                                                    <div className="space-y-3">
                                                        {currentProduct.salesHistory.map((h, i) => (
                                                            <div key={i} className="flex justify-between items-center border-b border-orange-200 dark:border-orange-800 pb-2 last:border-0 last:pb-0">
                                                                <div><div className="text-xs text-orange-500 dark:text-orange-400">{h.date}</div>{h.note && <div className="text-xs text-gray-500 dark:text-slate-400">{h.note}</div>}</div>
                                                                <div className="font-bold text-orange-900 dark:text-orange-100 text-lg">${h.price}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : <div>{currentProduct.lastSoldPrice ? <div className="flex justify-between font-bold text-orange-900 dark:text-orange-100 text-lg"><span>èˆŠç´€éŒ„å”®åƒ¹</span><span>${currentProduct.lastSoldPrice}</span></div> : <div className="text-sm text-gray-400 dark:text-slate-500 text-center py-2">æš«ç„¡éŠ·å”®ç´€éŒ„</div>}</div>}
                                            </div>
                                            {currentProduct.description && <div className="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl"><h3 className="text-xs font-bold text-purple-600 dark:text-purple-300 uppercase mb-2">éŠ·å”®æ–‡æ¡ˆ</h3><div className="text-sm text-gray-700 dark:text-slate-300 whitespace-pre-wrap leading-relaxed">{currentProduct.description}</div></div>}
                                        </div>
                                        <div className="space-y-4"><h3 className="font-bold text-gray-700 dark:text-slate-300">å¹³å°åƒ¹æ ¼</h3><div className="grid grid-cols-2 gap-3">{(currentProduct.platforms||[]).map((p,i)=> (<div key={i} className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl text-center border border-blue-100 dark:border-blue-800"><div className="text-blue-600 dark:text-blue-300 font-bold text-sm mb-1">{p.name}</div><div className="text-xl font-bold text-gray-800 dark:text-white">${p.price}</div></div>))}</div></div>
                                    </div>
                                </div>
                           </div>
                        </div>
                    )}

                    {/* Edit View */}
                    {view === 'edit' && currentProduct && (
                        <div className="fixed inset-0 z-40 bg-gray-50 dark:bg-slate-900 flex flex-col justify-center items-center md:bg-black/60 md:backdrop-blur-sm p-0 md:p-6">
                            <div className="w-full h-full md:w-full md:max-w-4xl md:h-[85vh] bg-white dark:bg-slate-800 md:rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                                <div className="bg-white dark:bg-slate-800 p-4 shadow-sm sticky top-0 z-10 flex justify-between items-center border-b border-gray-100 dark:border-slate-700">
                                    <button onClick={()=>setView('list')} className="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-full"><ArrowLeft className="text-gray-500 dark:text-slate-300"/></button>
                                    <h1 className="font-bold text-lg text-gray-800 dark:text-white">ç·¨è¼¯å•†å“</h1>
                                    <button onClick={handleSave} disabled={loading} className="text-blue-600 dark:text-blue-400 font-bold px-4 py-2 hover:bg-blue-50 dark:hover:bg-slate-700 rounded-lg transition-colors">{loading?'å„²å­˜ä¸­':'å®Œæˆ'}</button>
                                </div>
                                <div className="p-4 md:p-8 space-y-6 overflow-y-auto modal-scroll bg-gray-50/50 dark:bg-slate-900/50 flex-1">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="space-y-6">
                                            <div className="flex flex-col items-center gap-3">
                                                <div className="w-full aspect-square bg-gray-200 dark:bg-slate-700 rounded-xl overflow-hidden relative border-2 border-dashed border-gray-300 dark:border-slate-600 group hover:border-blue-400 transition-colors">
                                                    {currentProduct.image ? <img src={currentProduct.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex flex-col items-center justify-center text-gray-400 dark:text-slate-500"><Camera size={32}/><span className="text-xs mt-2">é»æ“Šä¸Šå‚³</span></div>}
                                                    <input type="file" accept="image/*" onChange={e=>{const f=e.target.files[0];if(f)compressImage(f).then(b=>setCurrentProduct(p=>({...p,image:b})))}} className="absolute inset-0 opacity-0 cursor-pointer" />
                                                </div>
                                                <button onClick={handleAIIdentify} disabled={aiLoading} className="w-full text-xs bg-indigo-100 dark:bg-indigo-900/50 hover:bg-indigo-200 dark:hover:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-4 py-2 rounded-lg flex items-center justify-center gap-2 transition-colors font-bold"><Sparkles size={14}/> {aiLoading?'AI è¾¨è­˜ä¸­...':'AI è¾¨è­˜åç¨±'}</button>
                                            </div>
                                        </div>

                                        <div className="md:col-span-2 space-y-6">
                                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 space-y-4">
                                                <div className="space-y-1"><label className="text-xs font-bold text-gray-500 dark:text-slate-400 uppercase ml-1">å•†å“åç¨±</label><input value={currentProduct.name} onChange={e=>setCurrentProduct({...currentProduct, name:e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 dark:text-white focus:border-blue-500 rounded-lg outline-none" placeholder="è¼¸å…¥å•†å“åç¨±" /></div>
                                                
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div className="space-y-1">
                                                        <label className="text-xs font-bold text-gray-500 dark:text-slate-400 uppercase ml-1">åˆ†é¡ (Category)</label>
                                                        <div className="flex gap-2">
                                                            <div className="relative flex-1">
                                                                <Tag className="absolute left-3 top-3 text-gray-400" size={18}/>
                                                                <input value={currentProduct.category || ''} onChange={e => setCurrentProduct({...currentProduct, category: e.target.value})} className="w-full pl-10 p-3 bg-gray-50 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 dark:text-white focus:border-blue-500 rounded-lg outline-none" placeholder="åˆ†é¡" />
                                                            </div>
                                                            <button onClick={() => setShowCatManager(true)} className="px-3 bg-gray-100 dark:bg-slate-600 rounded-lg text-gray-500 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-500 transition-colors" title="ç®¡ç†åˆ†é¡"><Settings size={20}/></button>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-1">
                                                        <label className="text-xs font-bold text-gray-500 dark:text-slate-400 uppercase ml-1">åº«å­˜æ•¸é‡ (Stock)</label>
                                                        <div className="relative">
                                                            <Archive className="absolute left-3 top-3 text-gray-400" size={18}/>
                                                            <input type="number" value={currentProduct.stock || 0} onChange={e => setCurrentProduct({...currentProduct, stock: parseInt(e.target.value) || 0})} className="w-full pl-10 p-3 bg-gray-50 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 dark:text-white focus:border-blue-500 rounded-lg outline-none" placeholder="0" />
                                                        </div>
                                                    </div>
                                                </div>
                                                {categories.length > 1 && (
                                                    <div className="flex flex-wrap gap-2 pt-1">
                                                        {categories.filter(c => c !== 'å…¨éƒ¨').map(cat => (
                                                            <button key={cat} onClick={() => setCurrentProduct({...currentProduct, category: cat})} className={`px-3 py-1 text-xs rounded-full transition-colors border ${currentProduct.category === cat ? 'bg-blue-600 text-white border-blue-600' : 'bg-white dark:bg-slate-700 text-gray-600 dark:text-slate-300 border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-600'}`}>
                                                                {cat}
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}
                                                
                                                <div className="space-y-1">
                                                    <label className="text-xs font-bold text-gray-500 dark:text-slate-400 uppercase ml-1">æ¢ç¢¼ (Barcode)</label>
                                                    <div className="flex gap-2">
                                                        <input value={currentProduct.barcode} onChange={e=>setCurrentProduct({...currentProduct, barcode:e.target.value})} className="flex-1 p-3 bg-gray-50 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 dark:text-white focus:border-blue-500 rounded-lg outline-none font-mono" placeholder="æƒææˆ–æ‰‹å‹•è¼¸å…¥" />
                                                        <button onClick={()=>{setScanCallback('edit');setView('scan')}} className="px-4 py-2 bg-gray-800 hover:bg-gray-700 dark:bg-slate-600 dark:hover:bg-slate-500 text-white rounded-lg transition-colors flex items-center gap-2 whitespace-nowrap"><Camera size={18} /><span>æƒæè®€å–</span></button>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 space-y-3">
                                                <label className="text-xs font-bold text-orange-600 dark:text-orange-400 uppercase flex items-center gap-2"><Clock size={14}/> æ­·å²éŠ·å”®ç´€éŒ„ç®¡ç†</label>
                                                <div className="flex flex-col gap-2 bg-orange-50 dark:bg-orange-900/10 p-3 rounded-lg border border-orange-100 dark:border-orange-800/50">
                                                    <div className="flex gap-2">
                                                        <input type="date" value={newHistory.date} onChange={e=>setNewHistory({...newHistory, date:e.target.value})} className="flex-1 p-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg text-sm dark:text-white outline-none focus:border-orange-500" />
                                                        <input type="number" value={newHistory.price} onChange={e=>setNewHistory({...newHistory, price:e.target.value})} className="w-24 p-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg text-sm dark:text-white outline-none focus:border-orange-500" placeholder="åƒ¹æ ¼ $" />
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <input value={newHistory.note} onChange={e=>setNewHistory({...newHistory, note:e.target.value})} className="flex-1 p-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg text-sm dark:text-white outline-none focus:border-orange-500" placeholder="å‚™è¨» (å¦‚: ç›´æ’­å„ªæƒ )" />
                                                        <button onClick={handleAddHistory} className="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold rounded-lg whitespace-nowrap">â• åŠ å…¥</button>
                                                    </div>
                                                </div>
                                                <div className="max-h-40 overflow-y-auto space-y-2 mt-2">{currentProduct.salesHistory?.map((h, i) => (<div key={h.id || i} className="flex justify-between items-center bg-gray-50 dark:bg-slate-700/50 p-2 rounded-lg text-sm border border-gray-100 dark:border-slate-700"><div className="flex-1"><span className="font-mono text-gray-500 dark:text-slate-400 mr-2">{h.date}</span><span className="font-bold text-gray-800 dark:text-white mr-2">${h.price}</span><span className="text-gray-400 text-xs">{h.note}</span></div><button onClick={()=>{const n=currentProduct.salesHistory.filter(x=>x.id!==h.id);setCurrentProduct({...currentProduct,salesHistory:n})}} className="text-red-400 hover:text-red-600 p-1"><X size={14}/></button></div>))}</div>
                                            </div>

                                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
                                                <div className="flex justify-between mb-2 items-center"><label className="text-xs font-bold text-gray-500 dark:text-slate-400 uppercase">éŠ·å”®æ–‡æ¡ˆ</label><button onClick={handleAIGenerateDesc} className="text-xs bg-purple-100 dark:bg-purple-900/50 hover:bg-purple-200 dark:hover:bg-purple-900 text-purple-700 dark:text-purple-300 px-3 py-1 rounded-full flex gap-1 transition-colors"><Wand size={12}/> AI ç”Ÿæˆ</button></div>
                                                <textarea value={currentProduct.description||''} onChange={e=>setCurrentProduct({...currentProduct, description:e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 dark:text-white rounded-lg h-24 outline-none focus:border-purple-500 transition-all resize-none" placeholder="è¼¸å…¥æˆ–ç”ŸæˆéŠ·å”®æ–‡æ¡ˆ..." />
                                            </div>

                                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 space-y-3">
                                                <div className="flex justify-between items-center">
                                                    <h3 className="font-bold text-gray-700 dark:text-slate-300">å¹³å°åƒ¹æ ¼</h3>
                                                    <div className="flex gap-2">
                                                        <button onClick={handleAIPriceEstimate} className="text-xs bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 px-3 py-1 rounded-full flex items-center gap-1 hover:bg-green-200 transition-colors"><DollarSign size={12}/> AI ä¼°åƒ¹</button>
                                                        <button onClick={()=>setCurrentProduct({...currentProduct, platforms:[...currentProduct.platforms,{name:'',price:''}]})} className="text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-700 p-1 rounded transition-colors"><Plus size={20}/></button>
                                                    </div>
                                                </div>
                                                {currentProduct.platforms.map((p,i)=>(<div key={i} className="flex gap-2 items-center"><input value={p.name} onChange={e=>{const n=[...currentProduct.platforms];n[i].name=e.target.value;setCurrentProduct({...currentProduct,platforms:n})}} className="flex-1 p-2 bg-gray-50 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 dark:text-white rounded focus:border-blue-500 outline-none" placeholder="å¹³å°åç¨±" /><input type="number" value={p.price} onChange={e=>{const n=[...currentProduct.platforms];n[i].price=e.target.value;setCurrentProduct({...currentProduct,platforms:n})}} className="w-24 p-2 bg-gray-50 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 dark:text-white rounded focus:border-blue-500 outline-none" placeholder="$" /><button onClick={()=>setCurrentProduct({...currentProduct,platforms:currentProduct.platforms.filter((_,idx)=>idx!==i)})} className="text-gray-400 dark:text-slate-500 hover:text-red-500 transition-colors"><X size={18}/></button></div>))}
                                            </div>

                                            {currentProduct.id && <button onClick={()=>handleDelete(currentProduct.id)} className="w-full py-3 text-red-600 dark:text-red-400 font-bold bg-white dark:bg-slate-800 border border-red-200 dark:border-red-900 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-xl transition-colors">åˆªé™¤æ­¤å•†å“</button>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Category Manager Modal */}
                    {showCatManager && (
                        <CategoryManager 
                            categories={categories} 
                            products={products}
                            onRename={handleRenameCategory}
                            onDelete={handleDeleteCategory}
                            onClose={() => setShowCatManager(false)} 
                            onAdd={handleAddManualCategory}
                        />
                    )}

                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
